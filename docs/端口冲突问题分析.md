# 端口冲突问题分析

## 当前情况分析

### 1. 端口占用情况
- **kubectl port-forward** 进程已退出（Exit 1），但可能端口还未完全释放
- 6379 端口可能仍被占用或处于 TIME_WAIT 状态

### 2. Redis 容器状态
- **redis** 容器：状态为 `Created`（已创建但未启动）
  - 原因：启动时端口绑定失败，容器创建成功但无法启动
- **ruoyi-redis** 容器：状态为 `Exited`（已停止）
  - 这是旧的容器，不影响当前问题

## 解决方案

### 步骤 1：清理处于 Created 状态的容器

```bash
# 删除处于 Created 状态的 redis 容器
docker rm redis

# 或者强制删除
docker rm -f redis
```

### 步骤 2：等待端口完全释放（可选）

如果端口还在 TIME_WAIT 状态，等待几秒：

```bash
# 等待 5 秒
sleep 5

# 再次检查端口
sudo lsof -i :6379
```

### 步骤 3：检查并清理 kubectl port-forward 残留

```bash
# 查找所有 kubectl 进程
ps aux | grep kubectl

# 如果有残留进程，杀掉它们
pkill -f "kubectl port-forward.*6379"
```

### 步骤 4：重新启动 Docker Compose

```bash
# 重新启动
docker compose up -d

# 查看日志确认启动成功
docker compose logs redis
```

## 一键解决脚本

```bash
#!/bin/bash
echo "=== 清理 Redis 容器 ==="
docker rm -f redis 2>/dev/null || echo "没有 redis 容器需要删除"

echo ""
echo "=== 清理 kubectl port-forward 进程 ==="
pkill -f "kubectl port-forward.*6379" 2>/dev/null || echo "没有相关进程"

echo ""
echo "=== 等待端口释放 ==="
sleep 3

echo ""
echo "=== 检查端口状态 ==="
if sudo lsof -i :6379 > /dev/null 2>&1; then
    echo "警告：6379 端口仍被占用"
    sudo lsof -i :6379
else
    echo "6379 端口可用"
fi

echo ""
echo "=== 启动 Docker Compose ==="
docker compose up -d

echo ""
echo "=== 检查 Redis 容器状态 ==="
sleep 2
docker ps | grep redis
```
